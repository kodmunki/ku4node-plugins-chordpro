var $kernel = require("ku4node-kernel"),
    $ = $kernel.asserters,
    $str = $kernel.str,

    json = {
        serialize: function(obj) {
            if ($.isNull(obj)) return null;
            if ($.isUndefined(obj)) return undefined;
            if (!$.isArray(obj) && !$.isObject(obj))
                return obj.toString();
            var r = [],
                f = ($.isArray(obj)) ? "[{0}]" : "{{0}}";
            for (var n in obj) {
                var o = obj[n];
                if ($.isFunction(o)) continue;
                var v = ($.isUndefined(o))
                    ? '"' + "undefined" + '"'
                    : ($.isNumber(o))
                    ? o
                    : ($.isString(o))
                    ? '"' + json_serializeString(o) + '"'
                    : json.serialize(o);
                r[r.length] = (($.isObject(obj) && !$.isArray(obj))
                    ? ("\"" + n + "\"" + ":")
                    : "") + v;
            }
            return $str.format(f, r);
        },
        deserialize: function(str) {
            if ($.isObject(str)) return str;
            if ($.isString(str))
                try { return eval("(" + json_deserializeString(str) + ")"); }
                catch (e) { return str; }
            return undefined;
        }
    }
    function json_serializeString(str) {
        return str
            .replace(/\\/g,"\\\\")
            .replace(/\"/g,"\\\"")
            .replace(/\//g,"\/")
            .replace(/\f/g,"\\f")
            .replace(/\n/g,"\\n")
            .replace(/\r/g,"\\r")
            .replace(/\t/g,"\\t")
            .replace(/\u0000/,"\\u0000")
            .replace(/\u0001/,"\\u0001")
            .replace(/\u0002/,"\\u0002")
            .replace(/\u0003/,"\\u0003")
            .replace(/\u0004/,"\\u0004")
            .replace(/\u0005/,"\\u0005")
            .replace(/\u0006/,"\\u0006")
            .replace(/\u0007/,"\\u0007")
            .replace(/\u0008/,"\\u0008")
            .replace(/\u0009/,"\\u0009")
            .replace(/\u000a/,"\\u000a")
            .replace(/\u000b/,"\\u000b")
            .replace(/\u000c/,"\\u000c")
            .replace(/\u000d/,"\\u000d")
            .replace(/\u000e/,"\\u000e")
            .replace(/\u000f/,"\\u000f")
            .replace(/\u0010/,"\\u0010")
            .replace(/\u0011/,"\\u0011")
            .replace(/\u0012/,"\\u0012")
            .replace(/\u0013/,"\\u0013")
            .replace(/\u0014/,"\\u0014")
            .replace(/\u0015/,"\\u0015")
            .replace(/\u0016/,"\\u0016")
            .replace(/\u0017/,"\\u0017")
            .replace(/\u0018/,"\\u0018")
            .replace(/\u0019/,"\\u0019")
            .replace(/\u001a/,"\\u001a")
            .replace(/\u001b/,"\\u001b")
            .replace(/\u001c/,"\\u001c")
            .replace(/\u001d/,"\\u001d")
            .replace(/\u001e/,"\\u001e")
            .replace(/\u001f/,"\\u001f");
    }
    function json_deserializeString(str) {
        return str
            .replace(/\\\//g,"/")
            .replace(/\\\\f/g,"\\f")
            .replace(/\\\\n/g,"\\n")
            .replace(/\\\\r/g,"\\r")
            .replace(/\\\\t/g,"\\t")
            .replace(/\\\\u0000/,"\\u0000")
            .replace(/\\\\u0001/,"\\u0001")
            .replace(/\\\\u0002/,"\\u0002")
            .replace(/\\\\u0003/,"\\u0003")
            .replace(/\\\\u0004/,"\\u0004")
            .replace(/\\\\u0005/,"\\u0005")
            .replace(/\\\\u0006/,"\\u0006")
            .replace(/\\\\u0007/,"\\u0007")
            .replace(/\\\\u0008/,"\\u0008")
            .replace(/\\\\u0009/,"\\u0009")
            .replace(/\\\\u000a/,"\\u000a")
            .replace(/\\\\u000b/,"\\u000b")
            .replace(/\\\\u000c/,"\\u000c")
            .replace(/\\\\u000d/,"\\u000d")
            .replace(/\\\\u000e/,"\\u000e")
            .replace(/\\\\u000f/,"\\u000f")
            .replace(/\\\\u0010/,"\\u0010")
            .replace(/\\\\u0011/,"\\u0011")
            .replace(/\\\\u0012/,"\\u0012")
            .replace(/\\\\u0013/,"\\u0013")
            .replace(/\\\\u0014/,"\\u0014")
            .replace(/\\\\u0015/,"\\u0015")
            .replace(/\\\\u0016/,"\\u0016")
            .replace(/\\\\u0017/,"\\u0017")
            .replace(/\\\\u0018/,"\\u0018")
            .replace(/\\\\u0019/,"\\u0019")
            .replace(/\\\\u001a/,"\\u001a")
            .replace(/\\\\u001b/,"\\u001b")
            .replace(/\\\\u001c/,"\\u001c")
            .replace(/\\\\u001d/,"\\u001d")
            .replace(/\\\\u001e/,"\\u001e")
            .replace(/\\\\u001f/,"\\u001f");
    }
module.exports = json;